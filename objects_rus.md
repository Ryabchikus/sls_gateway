# Объекты

Объекты это универсальная сущность для хранения и обмена данными между подсистемами шлюза, например между скриптами.

Доступ к объекту осуществляется по его имени:
```lua
local current, previos, flags = obj.get("security.status")
```
Доступно получение текущего `current` и предыдущего `previos` значения и флагов `flags`. 

## Веб интерфейс
Просмотреть текущие объекты можно на странице Objects.

![object](/img/obj.png)

- Флаг N (Notify) - при изменении значения объекта значение передается в MQTT (описание ниже),
- Флаг A (Ack) - при изменении значения объекта передан признак Ack (описание ниже).
- Флаг W (Write) - изменение значения при каждом обращении на запись объекта

## Инициализация объектов
В данный момент объекты хранятся только в памяти и не сохраняются в флеш-память. Поэтому необходимо позаботиться об их инициализации при старте шлюза.

Инициализировать  объекты   можно в стартовом скрипте *init.lua*:
```lua
obj.setOpt("security.status", "BOOL")
```

Третий параметр является опциональным, при передаче true  включается отправка  уведомления в MQTT:
```lua
obj.setOpt("security.status", "BOOL", true)
```

### Типы данных

Объекту может хранить следующие типы:
- STR - Строки (используется по умолчанию)
- BOOL - Бинарный (true / false)
- INT - Целое число
- FLOAT - Дробное число
- JSON - строка формата JSON

При изменении значения объекта можно вызвать  lua-сценарий, для этого в `init.lua` можно указать. 

```lua
obj.setScript('security.status', 'security_event.lua')
-- security.status - имя объекта
-- security_event.lua - имя файла скрипта с расширением
-- run_on_write - BOOL, false (default) = запуск при обновлении значения; true = запуск каждый раз при записи значения в объект + поднимается флаг W
```
При изменении значения объекта  `security.status` будет вызываться скрипт `security_event.lua`.
Для того, чтобы при изменении значения объекта `security.status` при установке шлюз не уходил в бесконечный цикл, есть возможность управлять обратной связью.  

## Обратная связь при изменении значения объектов
Объекты поддерживают установку флага обратной связи, таким образом можно в вызываемом скрипте можно получить информацию об источнике изменения. 

Установить флаг можно передав true как 3-й параметр в `obj.set()`

Флаг обратной связи виден в веб-интерфейсе (**A**), а так же 3-й параметр который возвращает `obj.get()`.

При запуске привязанного к объекту скрипта, флаг так же передается содержится в `Event.Obj.Ack`

Пример установки значения объекта `security.status`:
```lua
obj.set("security.status", true)
```

Установка значения `security.status` с передачей `Ack`:
```lua
obj.set("security.status", true, true)
```

Пример скрипта-обработчика `security_event.lua` (скрипт ранее был привязан к объекту в `init.lua`):
```lua
local status = ""
local current_status, previous_status, ack = obj.get("security.status")
-- добавим обработчик булевых значений для склейки со строками
if current_status == true then
  status = "true" 
else
  status = "false"
end
-- отправляем уведомление только  в случае изменения значений с признаком ackw  
if ack == true then
  telegram.send("wsecurity status is " .. status)
end
```

## Работа с объектами из скриптов

Примеры работы с объектом `security.status`

Установка значения объекта:
```lua
obj.set("security.status", true)
```

Установка значения объекта с передачей ACK:
```lua
obj.set("security.status", true, true)
```

Удаление объекта:
```lua
obj.remove("security.status")
```

Для изменения типа переменной:
```lua
obj.setOpt("security.status", "INT")
```

Включение уведомления об изменении в MQTT:
```lua
obj.setOpt("security.status", "INT", true)
```

Получение времени изменения объекта в секундах:
```lua
local curr, prev = obj.getTime("security.status")
print("Время предыдущего изменения:" .. prev .. ", И последнего: " .. curr .. " длительность события: " .. curr-prev)
```
[Подробное описание API Lua.](/lua_rus.md#Библиотека-OBJ)

## События

При вызове скрипта привязанного к объекту вызывается событие с типом `SCRIPT_EVENT_TYPE_OBJ_CHANGE` и значением 2.

Передается имя объекта, его текущее и предыдущее значение, флаг обратной связи.

```lua
if Event.Type == 2 then
  local Name = Event.Obj.Name
  local Value = Event.Obj.Value
  local OldValue = Event.Obj.OldValue
  local Ack = Event.Obj.Ack
end
```

## MQTT
Шлюз может отправлять уведомления в MQTT при изменении объекта, это включается через 3 параметр `obj.setOpt()`.

Шлюз будет публиковать в топик вида: `zgwXXXX/obj/OBJ_NAME`

Для изменения объекта необходимо отправить значение объекта в топик `zgwXXXX/obj/OBJ_NAME/set`

Для запроса текущего значения объекта необходимо отправить пустой топик `zgwXXXX/obj/OBJ_NAME/get`

## Сетевые объекты
Используются для синхронизации данных между несколькими шлюзами, при изменении объекта на одном, он так же изенится и на остальных шлюзах.

Данный функционал в разработке.

## Доступ к объектам через [HTTP API](/http_api_rus.md)
Доступны следующие методы:

- GET `/api/obj` - Получить список объектов
- GET `/api/obj?name=XXX` - Получить значение объекта `XXX`
- GET[POST] `/api/obj?name=XXX&value=YYY` - Установить значение `YYY` объекта `XXX`
- DELETE `/api/obj?name=obj_name` - Удалить объект `obj_name` с устройства
